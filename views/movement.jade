extends layout

block content
  script.
    var rplot;
    var colors = [ "#0071bc" ];
    $(document).ready(function(){
      function format_unixtime(unixtime) {
        var a = new Date(unixtime*1000);  
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var year = a.getFullYear();
        var month = months[a.getMonth()];
        var date = a.getDate();
        var hour = a.getHours();
        var min = a.getMinutes();
        var sec = a.getSeconds();
        var suffix = 'th'
        if (date == 1 || date == 21 || date == 31)
          suffix = 'st';
        if (date == 2 || date == 22 || date == 32)
          suffix = 'nd';
        if (date == 3 || date == 23)
          suffix = 'rd';
        if (hour < 10)
          hour = '0' + hour;
        if (min < 10)
          min = '0' + min;
        if (sec < 10)
          sec = '0' + sec;
        var time = date + suffix + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;   
        return time;
      }

      /*function changeChartAmount() {
        alert('changeChartAmount');
        var baseTime = parseInt(new Date().getTime()/1000) - 60 * 86400;
        var chartAmount = document.getElementById("chartAmount");
        var timeData = [];
        var timestampData = [];
        var timeNumData = [];
        for(var i = 0; i < 60; i++)
        {
          var time = baseTime + i * 86400;
          var strTime = format_unixtime_to_day(time);
          timeData.push(strTime);
          timestampData.push(time);
          timeNumData.push(0);
        }
        var url = '';
        url='/ext/gettxs?&second=' + baseTime + '&amount=' + chartAmount.value;
        alert(url);
        
        var ajaxReq = $.ajax ({
          url: url,
          success: function( json ){
            alert('test99');
            var j = 0;
            for ( var i=json.data.length-1;i>=0; i-- ) {
              if(json.data[i].timestamp >= timestampData[j] && json.data[i].timestamp <= timestampData[j+1])
              {
                timeNumData[j]++;
              }
              else
              {
                j++;
                for(; j < 60; j++)
                {
                  if(json.data[i].timestamp >= timestampData[j] && json.data[i].timestamp <= timestampData[j+1])
                  {
                    timeNumData[j]++;
                    break;
                  }
                  else
                  {
                    j++;
                  }
                }
              }
            }
            alert('test123');
            var myMapCharts = echarts.init(document.getElementById('bigChangeChart'));
            alert('test2');
            option = {
                backgroundColor: '#F0FFF0',
                title: {
                  text: 'bigchange',
                  left: 'center'
                },
                tooltip: {
                  trigger: 'axis',
                  position: function (pt) {
                    return [pt[0], '10%'];
                  }
                },
                toolbox: {
                  feature: {
                    dataZoom: {
                      yAxisIndex: 'none'
                    },
                    restore: {},
                    saveAsImage: {}
                  }
                },
                xAxis: {
                  type: 'category',
                  boundaryGap: false,
                  data: timeData
                },
                yAxis: {
                  type: 'value',
                  data: timeNumData,
                  boundaryGap: [0, '100%']
                },
                dataZoom: [{
                  type: 'inside',
                  start: 0,
                  end: 100
                }, {
                  start: 0,
                  end: 100,
                  handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                  handleSize: '80%',
                  handleStyle: {
                    color: '#fff',
                    shadowBlur: 3,
                    shadowColor: 'rgba(0, 0, 0, 0.6)',
                    shadowOffsetX: 2,
                    shadowOffsetY: 2
                  }
                }],
                series: [
                {
                  name:'模拟数据',
                  type:'line',
                  smooth:true,
                  symbol: 'none',
                  sampling: 'average',
                  itemStyle: {
                    color: 'rgb(255, 70, 131)'
                  },
                  areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                      offset: 0,
                      color: 'rgb(255, 158, 68)'
                    }, {
                      offset: 1,
                      color: 'rgb(255, 70, 131)'
                    }])
                  },
                  data: timeNumData
                }
                ]
              };
            alert('test3');
            myMapCharts.setOption(option);
            alert('test4');
          }
        });
      }

      changeChartAmount();*/

      var rtable = $('#alerts-table').dataTable( {  
        autoWidth: false,      
        searching: false,
        ordering: false,
        //responsive: true,
        lengthChange: false,
        //processing: true,
        ajax: {
          url: '/ext/getlasttxs/#{min_amount}',
          dataSrc: function ( json ) {
            for ( var i=0;i<json.data.length; i++ ) {
              json.data[i]['timestamp'] = new Date((json.data[i]['timestamp']) * 1000).toLocaleString();//format_unixtime(json.data[i]['timestamp']);
              json.data[i]['txid'] = "<a href='/tx/" + json.data[i]['txid'] + "' class='mono' target='_blank'>" + json.data[i]['txid'] + "</a>"
              var amount = json.data[i]['total'] / 100000000;
              if (amount > '#{flagb}') {
                json .data[i]['total'] = "<label class='label label-danger'>" + amount + "</label>";
              } else if (amount > '#{flaga}') {
                json .data[i]['total'] = "<label class='label label-warning'>" + amount + "</label>";
              } else {
                json .data[i]['total'] = "<label class='label label-success'>" + amount + "</label>";
              }
            }
            return json.data;
          }
        },
        columns: [
          { data: 'timestamp', width: '25%' },
          { data: 'txid', width: '60%' },
          { data: 'total', width: '15%' },
        ]
      });
      setInterval( function () {
        rtable.api().ajax.reload(null, false);
        //bigChangeChartTable.api().ajax.reload(null, false);
      }, 45000 );
    });
    //updateValue();

    function format_unixtime_to_day(unixtime) {
      var a = new Date(unixtime*1000);  
      var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      var year = a.getFullYear();
      var month = months[a.getMonth()];
      var date = a.getDate();
      var time = year + ' ' + month + ' ' + date;   
      return time;
    }

    function changeChartAmount() {
      //alert('changeChartAmount');
      var baseTime = parseInt(new Date().getTime()/1000) - 60 * 86400;
      var amount = document.getElementById("chartAmount");
      if(amount == null)
      {
        amount = {value:100};
      }
      var timeData = [];
      var timestampData = [];
      var timeNumData = [];
      //alert('changeChartAmount2');
      for(var i = 0; i < 60; i++)
      {
        var time = baseTime + i * 86400;
        var strTime = format_unixtime_to_day(time);
        timeData.push(strTime);
        timestampData.push(time);
        timeNumData.push(0);
      }
      //alert('changeChartAmount3');
      var url = '';
      //alert('changeChartAmount4');
      //alert(baseTime);
      //alert(amount);
      url='/ext/gettxs?&second=' + baseTime + '&amount=' + amount.value;
      //alert('changeChartAmount5');
      alert(url);
      var ajaxReq = $.ajax ({
        url: url,
        success: function( json ){
          //alert(json.data.length);
          var j = 0;
          for ( var i=json.data.length-1;i>=0; i-- ) {
            if(json.data[i].timestamp >= timestampData[j] && json.data[i].timestamp <= timestampData[j+1])
            {
              timeNumData[j]++;
            }
            else
            {
              j++;
              for(; j < 60; j++)
              {
                if(json.data[i].timestamp >= timestampData[j] && json.data[i].timestamp <= timestampData[j+1])
                {
                  timeNumData[j]++;
                  break;
                }
                else
                {
                  j++;
                }
              }
            }
          }
          //alert('test123');
          var myMapCharts = echarts.init(document.getElementById('bigChangeChart'));
          //alert('test2');
          option = {
            backgroundColor: '#F0FFF0',
            title: {
              text: 'bigchange',
              left: 'center'
            },
            tooltip: {
              trigger: 'axis',
              position: function (pt) {
                return [pt[0], '10%'];
              }
            },
            toolbox: {
              feature: {
                dataZoom: {
                  yAxisIndex: 'none'
                },
                restore: {},
                saveAsImage: {}
              }
            },
            xAxis: {
              type: 'category',
              boundaryGap: false,
              data: timeData
            },
            yAxis: {
              type: 'value',
              data: timeNumData,
              boundaryGap: [0, '50%']
            },
            dataZoom: [{
              type: 'inside',
              start: 0,
              end: 100
            }, {
              start: 0,
              end: 100,
              handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
              handleSize: '80%',
              handleStyle: {
                color: '#fff',
                shadowBlur: 3,
                shadowColor: 'rgba(0, 0, 0, 0.6)',
                shadowOffsetX: 2,
                shadowOffsetY: 2
              }
            }],
            series: [
            {
              name:'模拟数据',
              type:'line',
              smooth:true,
              symbol: 'none',
              sampling: 'average',
              itemStyle: {
                color: 'rgb(255, 70, 131)'
              },
              areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                  offset: 0,
                  color: 'rgb(255, 158, 68)'
                }, {
                  offset: 1,
                  color: 'rgb(255, 70, 131)'
                }])
              },
              data: timeNumData
            }
            ]
          };
          //alert('test3');
          myMapCharts.setOption(option);
          //alert('test4');
        }
      });
    }

    changeChartAmount();

    var bigChangeTable = null;
    function updateValue()
    {
      //alert('updateValue');
      var date = document.getElementById("selectDate");
      alert(date.value);
      var chooseAmount = document.getElementById("amount");
      alert(chooseAmount.value);
      var address = document.getElementById("address");
      alert(address.value);
      var time = parseInt(new Date().getTime()/1000 - date.value * 86400);
      var url = '';
      if(address.value == '')
      {
        url='/ext/gettxs?&second=' + time + '&amount=' + chooseAmount.value;
      }
      else
      {
        url='/ext/gettxs?&second=' + time + '&amount=' + chooseAmount.value + '&address=' + address.value;
      }

      if(bigChangeTable)
      {
        bigChangeTable.fnClearTable();
        $('#big-change-table').dataTable().fnDestroy();
      }
      
      //alert(url);
      bigChangeTable = $('#big-change-table').dataTable( {  
        autoWidth: false,      
        searching: false,
        ordering: false,
        lengthChange: false,
        //retrieve: true,
        ajax: {
          url: url,
          dataSrc: function ( json ) {
            alert(json.data.length);
            for ( var i=0;i<json.data.length; i++ ) {
              var amount = json.data[i]['total'] / 100000000;
              json.data[i]['timestamp'] = new Date((json.data[i]['timestamp']) * 1000).toLocaleString();//format_unixtime(json.data[i]['timestamp']);
              json.data[i]['txid'] = "<a href='/tx/" + json.data[i]['txid'] + "' class='mono' target='_blank'>" + json.data[i]['txid'] + "</a>"
              if (amount > '#{flagb}') {
                json.data[i]['total'] = "<label class='label label-danger'>" + amount + "</label>";
              } else if (amount > '#{flaga}') {
                json.data[i]['total'] = "<label class='label label-warning'>" + amount + "</label>";
              } else {
                json.data[i]['total'] = "<label class='label label-success'>" + amount + "</label>";
              }
              if(json.data[i].vin.length == 0)
              {
                json.data[i]['address'] = 'PoS';
              }
              else
              {
                json.data[i]['address'] = json.data[i].vin[0]['addresses'];
              }
              json.data[i]['height'] = 'Todo';
            }
            return json.data;
          }
        },
        columns: [
          { data: 'timestamp', width: '25%' },
          { data: 'address', width: '25%' },
          { data: 'height', width: '25%' },
          { data: 'total', width: '25%' },
          { data: 'txid', width: '25%' },
        ]
      });
      //var oSettings = bigChangeTable.fnSettings();
      //oSettings.sAjaxSource = url;
      //bigChangeTable.Draw();
      //bigChangeTable.fnClearTable(false);
    }

    updateValue();

    function addChartAmount()
    {
      alert('addChartAmount');
      var amount = document.getElementById("chartAmount");
      var tmp = amount.value;
      tmp++;
      amount.value = tmp;
      alert('addChartAmount2');
      changeChartAmount();
    }
    function subChartAmount()
    {
      alert('subChartAmount');
      var amount = document.getElementById("chartAmount");
      var tmp = amount.value;
      tmp--;
      amount.value = tmp;
      changeChartAmount();
    }
    function addAmount()
    {
      var amount = document.getElementById("amount");
      var tmp = amount.value;
      tmp++;
      amount.value = tmp;
      updateValue();
    }
    function subAmount()
    {
      var amount = document.getElementById("amount");
      var tmp = amount.value;
      tmp--;
      amount.value = tmp;
      updateValue();
    }
    

  .col-xs-12.col-md-10.col-md-offset-1(style="margin-bottom: 5%")
    table#alerts-table.table.table-striped.table-bordered
      thead
        th 时间 
        th.hidden-xs 交易哈希
        th 金额
  
  .row
      .col-md-offset-5.col-md-2
        label #{settings.locale.bigchange}
        br
      .col-lg-3.pull-right
        br
        | 金额: >=
        input#chartAmount(type='number', onchange='changeChartAmount()', value='100')
        | VP
        br
      .col-md-offset-1.col-md-10
        br
        #bigChangeChart(style='width: 100%; height: 600px;')

  .col-xs-12.col-md-10.col-md-offset-1(style="margin-bottom: 5%")
      | date:
      select#selectDate(color="#FF4040" onchange='updateValue()')
        option(value='1', selected='selected') 24hours
        option(value='7') weeks
        option(value='21') three weeks
        option(value='180') half yeahs
        option(value='365') yeah
        option(value='0') all
        label(for='test') test
        input#amount(type='number', value='100', onchange='updateValue()')
        .br
        | address：
        input#address(type='text', value='', onchange='updateValue()')

  .col-xs-12.col-md-10.col-md-offset-1(style="margin-bottom: 5%")
    table#big-change-table.table.table-striped.table-bordered
      thead
        th 时间 
        th.hidden-xs address
        th height
        th total
        th txid
 
