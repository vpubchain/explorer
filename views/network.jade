extends layout

block content   
  script.
    $(document).ready(function(){
      var ctable = $('#connections-table').dataTable( {  
        autoWidth: true,      
        searching: false,
        ordering: false,
        responsive: true,
        lengthChange: true,
        processing: true,
        ajax: {
          url: '/ext/connections',
          dataSrc: function ( json ) {
            /*for ( var i=0;i<json.data.length; i++ ) {
              json.data[i]['timestamp'] = new Date((json.data[i]['timestamp']) * 1000).toUTCString();
              json.data[i]['txid'] = "<a href='/tx/" + json.data[i]['txid'] + "'>" + json.data[i]['txid'] + "</a>";
              json.data[i]['blockindex'] = "<a href='/block/" + json.data[i]['blockhash'] + "'>" + json.data[i]['blockindex'] + "</a>";
              var amount = json.data[i]['total'] / 100000000;
              json.data[i]['total'] = amount.toFixed(8);
              json.data[i]['recipients'] = json.data[i]['vout'].length;
            }*/
            //alert('test2');
            return json.data;
          }
        },
        columns: [
          { data: 'address', width: '25%' },
          { data: 'protocol', width: '25%' },
          { data: 'version', width:'25%' },
          { data: 'country', width: '25%'}
        ]
      });

      var ntable = $('#nodes-table').dataTable( {  
        autoWidth: true,      
        //searching: false,
        ordering: false,
        responsive: true,
        lengthChange: true,
        processing: true,
        filter: true,  // 搜索栏
        searching: true, 
        ajax: {
          //url: 'http://127.0.0.1:5000/vpbitnodes/api/v1.0/snapshots/1552444356/',
          //url: '/ext/connections',
          url: '/bitcoin/api/nodes',
          dataSrc: function ( json ) {
            //alert(json.nodes);
            var res = {data:[]};
            //$('#useragentlist') = {};
            //var i = 0;
            for(var key in json.nodes) {
              //alert(key);
              var item = {'address':'','useragent':'',hight:0, 'location': '','network':'','time':''};
              item.address = key;
              var arr = json.nodes[key].toString().split(',');
              //alert(json.nodes[key]);
              //alert(arr[1]);
              item.useragent = arr[1] + '<br>' + arr[0];
              item.hight = arr[4];
              item.location = geolocation[arr[7]];
              //alert(item.location);
              //alert(geolocation[arr[7]]);
              item.network = arr[12] + '<br>' + arr[11];
              item.time = new Date((arr[2]) * 1000).toLocaleString();
              //item.user-agent = json.nodes[key].1;
              res.data.push(item);
              //i++;
            }
            return res.data;
          }
        },
        columns: [
          { data: 'time', width: '10%' },
          { data: 'address', width: '20%' },
          { data: 'useragent', width: '20%' },
          { data: 'hight', width:'10%' },
          { data: 'location', width:'20%' },
          { data: 'network', width: '20%'},
        ]
      });

      function getCity(x, y)
      {
        url = '/getlocation/' + x + '/' + y;
        alert(url);
        var ajaxRequest = $.ajax({
            url: url,
            success: function( res ) {
                alert(res);
                alert(res.result.addressComponent.city);
                return res.result.addressComponent.city;                
            }
        });      
      }
      function ajax_function()
      {
        var reqajax = $.ajax ({
          url: '/bitcoin/api/nodes',
          success: function( res ) {
            var myMapCharts = echarts.init(document.getElementById('mapChart'));
            var agents = res.agents;
            var countrys = res.countrys;
            var networks = res.networks;
            var nodes = res.nodes;
            var nodes_data = [];
            var items = [];
            /*var location = '#{location_city_list}';
            for(key in location)
            {
                alert(key);
            }*/
            
            for(var item in nodes){
              node_location = [];
              node_data = {};
              items = nodes[item];
              //alert(items);
              node_location.push(items[9]);
              node_location.push(items[8]);
              //var location_key = items[8]+items[9];
              //alert(location[location_key]);
              //var city = #bitnodeslist[location_key];
              //alert(city);
              //node_location.push("America/New_York");
              node_location.push(10);
              node_data.name = item;
              node_data.value = node_location;
              nodes_data.push(node_data);
            }
            option = {
              backgroundColor: '#303030',
              title: {
                text: '#{settings.locale.livemapcrawler}',
                subtext: '',
                sublink: '',
                left: 'left',
                top: 5,
                itemGap: 0,
                textStyle: {
                    color: '#eee'
                },
                z: 200
              },
            tooltip: {
                trigger: 'item',
                formatter: function (params) {
                    var value = (params.value + '').split('.');
                    //alert(value);
                    //var city = value[2];
                    //alert(params.value);
                    //value = value[0].replace(/(\d{1,3})(?=(?:\d{3})+(?!\d))/g, '$1,');
                    value = value[0].replace(/(\d{1,3})(?=(?:\d{3})+(?!\d))/g, '$1,') + '.' + value[1];
                    //return params.seriesName + '<br/>' + params.name + ' : ' + value;
                    return params.name + ' : ' + value;
                    //return city;
                }
            },
            toolbox: {
                show: true,
                left: 'right',
                iconStyle: {
                    normal: {
                        borderColor: '#ddd'
                    }
                },
                feature: {
                },
                z: 202
            },
            brush: {
                geoIndex: 0,
                brushLink: 'all',
                inBrush: {
                    opacity: 1,
                    symbolSize: 14
                },
                outOfBrush: {
                    color: '#000',
                    opacity: 0.2
                },
                z: 10
            },
            geo: {
                map: 'world',
                //map: 'china',
                silent: true,
                label: {
                    emphasis: {
                        show: false,
                        areaColor: '#eee'
                    }
                },
                itemStyle: {
                    normal: {
                        borderWidth: 0.2,
                        borderColor: '#404a59'
                    }
                },
                left: '0%',
                top: 40,
                bottom: '0%',
                right: '0%',
                roam: true
            },
            //: makeParallelAxis(schema),
            grid: [{
                show: true,
                left: 0,
                right: 0,
                top: '100%',
                bottom: 0,
                borderColor: 'transparent',
                backgroundColor: '#404a59',
                z: 99
            }],
            parallel: {
                top: '100%',
                left: 0,
                right: 0,
                bottom: 0,
                axisExpandable: true,
                axisExpandCenter: 15,
                axisExpandCount: 10,
                axisExpandWidth: 60,
                axisExpandTriggerOn: 'mousemove',

                z: 100,
                parallelAxisDefault: {
                    type: 'value',
                    nameLocation: 'start',
                    nameRotate: 25,
                    // nameLocation: 'end',
                    nameTextStyle: {
                        fontSize: 12
                    },
                    nameTruncate: {
                        maxWidth: 170
                    },
                    nameGap: 20,
                    splitNumber: 3,
                    tooltip: {
                        show: true
                    },
                    axisLine: {
                        // show: false,
                        lineStyle: {
                            width: 1,
                            color: 'rgba(255,255,255,0.3)'
                        }
                    },
                    axisTick: {
                        show: false
                    },
                    splitLine: {
                        show: false
                    },
                    z: 100
                }
            },
            series: [
            {
                name: 'Phore node',
                //type: 'scatter',
                type: 'effectScatter',
                legendHoverLink:true,       //是否启用图例 hover 时的联动高亮。
                hoverAnimation:true,        //是否开启鼠标 hover 的提示动画效果。
                effectType:"ripple",        //特效类型，目前只支持涟漪特效'ripple'。
                showEffectOn:"render",      //配置何时显示特效。可选：'render' 绘制完成后显示特效。'emphasis' 高亮（hover）的时候显示特效。
                rippleEffect:{              //涟漪特效相关配置。
                    period:4,               //动画的时间。
                    scale:5,              //动画中波纹的最大缩放比例。
                    brushType:'fill',      //波纹的绘制方式，可选 'stroke' 和 'fill'。
                },
                coordinateSystem: 'geo',
                //symbolSize: 8,
                data: nodes_data,//makeMapData(rawData),
                activeOpacity: 1,
                label: {
                    normal: {
                        formatter: '{b}',
                        position: 'right',
                        show: false
                    },
                    emphasis: {
                        show: true
                    }
                },
                //symbolSize: 10,
                symbolSize: function (data) {
                    return Math.max(5, data[2] / 5);
                },
                itemStyle: {
                    normal: {
                        borderColor: '#fff',
                        color: '#577ceb',
                    }
                }
            }/*,
            {
                name: 'parallel',
                type: 'parallel',
                smooth: true,
                lineStyle: {
                    normal: {
                        color: '#577ceb',
                        width: 0.5,
                        opacity: 0.6
                    }
                },
                z: 100,
                blendMode: 'lighter',
                data: rawData
            }*/
            ]
        };
          myMapCharts.setOption(option);    
          }
        });
        //alert('test');
      }

      ajax_function();
      setInterval( ajax_function, 60000 );
    });
  
  .col-md-12
      .hidden-xs.pull-right.btn-group
        //a.btn.btn-primary.btn-sm(href='live-map') #{settings.locale.livemap}
      h3
        a #{settings.locale.networkslapshot}
      p
        | #{settings.locale.snapshotreachable}
        span.timestamp #{snapshotlocaltime}
        | .
  .big.col-md-2.text-center
      br
      p.text-muted #{settings.locale.net_connections}
      h3 #{bitnodeslist.total_nodes}
      p.text-muted #{settings.locale.height}
      h3 #{bitnodeslist.latest_height}
      br

  .col-xs-12.col-md-8
    //.row.text-center(style='margin-bottom:15px;')
      //i #{settings.locale.net_warning}
    .tabpanel
      ul.nav.nav-tabs(role='tablist')
        li.active(role='presentation')
          a(href='#useragent', aria-controls='useragent', role='tab', data-toggle='tab') #{settings.locale.useragent}
        li(role='presentation')
          a(href='#country', aria-controls='country', role='tab', data-toggle='tab') #{settings.locale.net_country}
        li(role='presentation')
          a(href='#networks', aria-controls='networks', role='tab', data-toggle='tab') #{settings.locale.network}
    .tab-content
      #useragent.tabpanel.tab-pane.active 
        include ./includes/rl_bitnodes_useragent.jade
      #country.tabpanel.tab-pane 
        include ./includes/rl_bitnodes_country.jade
      #networks.tabpanel.tabpanel.tab-pane 
        include ./includes/rl_bitnodes_network.jade

  .row
      .col-md-offset-5.col-md-2
        label #{settings.locale.livemap}
      .col-md-offset-5
      .col-md-offset-1.col-md-10
        #mapChart(style='width: 100%; height: 600px;')

  .col-md-12(style="margin-bottom: 4%")
    .panel.panel-default
      .panel-heading
        strong #{settings.locale.net_connections}
      table#nodes-table.table.table-bordered.table-striped
        thead
          tr
            th.text-center #{settings.locale.timestamp}
            th.text-center #{settings.locale.tx_address}
            th.text-center #{settings.locale.net_subversion}
            th.text-center #{settings.locale.height}
            th.text-center #{settings.locale.net_country}
            th.text-center #{settings.locale.network}
        tbody.text-center
